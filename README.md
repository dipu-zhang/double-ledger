# Double-Entry Ledger API

A lightweight double-entry ledger HTTP/JSON API built with Node.js and TypeScript, featuring clean layered architecture and comprehensive validation. It follows the Conduit ledger challenge spec; extensions include optional multi-currency (USD, EUR, GBP, JPY, KWD), UUIDs for all IDs, and idempotency for transactions.

## Overview

This API implements a double-entry accounting ledger system where every financial transaction must be balanced: the sum of debits must equal the sum of credits. Account balances can only be changed by creating transactions (never set or updated directly). All balance updates are applied atomically, ensuring data integrity.

## Tech Stack

- **Runtime**: Node.js
- **Language**: TypeScript
- **Framework**: Express
- **Storage**: In-memory Maps (for simplicity)
- **Testing**: Jest + Supertest
- **Validation**: In-house validators (no external schema libraries)

## Architecture

The codebase follows a clean, domain-driven architecture organized by feature:

```
src/
├── accounts/
│   ├── dtos/
│   │   ├── requests/
│   │   └── responses/
│   ├── presenters/
│   ├── validators/
│   ├── account.service.ts
│   └── accounts.controller.ts
├── transactions/
│   ├── dtos/
│   │   ├── requests/
│   │   └── responses/
│   ├── presenters/
│   ├── validators/
│   ├── transaction.service.ts
│   └── transactions.controller.ts
└── shared/
    ├── entities/
    ├── errors/
    ├── repositories/
    └── types/
```

### Key Design Patterns

- **Layered Architecture**: Controller to Service to Repository
- **Domain-Driven Design**: Entities, DTOs, Presenters, Validators
- **Separation of Concerns**: Clear boundaries between layers
- **Atomicity**: All balance updates happen in a single step
- **Class-based Components**: Validators and Presenters are classes (DI-ready)

## Money Representation

All monetary values are stored as **integers** to avoid floating-point precision issues. This follows the same pattern as Stripe and other major payment APIs.

**Important:** Values represent the smallest currency unit:
- For USD: `100` = $1.00 (cents)
- For JPY: `100` = ¥100 (no decimals)
- For KWD: `1000` = 1.000 KWD (3 decimals)

**Default Currency:** USD

**Supported Currencies:**
- **USD** - US Dollar (2 decimals)
- **EUR** - Euro (2 decimals)
- **GBP** - British Pound (2 decimals)
- **JPY** - Japanese Yen (0 decimals)
- **KWD** - Kuwaiti Dinar (3 decimals)

**Currency in requests (per API contract):** Currency is **optional** in all relevant request bodies. You may omit it to use defaults (USD for accounts; account currency for transaction entries). Pass a currency only when you need multi-currency support (e.g. EUR or GBP). If not specified, USD is used by default for accounts.

## Setup Instructions

### 1. Install Dependencies

```bash
npm install
```

### 2. Build the Project

```bash
npm run build
```

### 3. Run the Server

```bash
npm start
```

The API will start on port 3000 (or the port specified in `PORT` environment variable).

### 4. Development Mode

```bash
npm run dev
```

### 5. Run Tests

```bash
npm test
```

Run tests in watch mode:

```bash
npm run test:watch
```

Run tests with coverage:

```bash
npm run test:coverage
```

## API Endpoints

### 1. Create Account

**POST** `/accounts`

Creates a new ledger account.

**Request Body:**

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Cash",
  "direction": "debit",
  "balance": 0,
  "currency": "USD"
}
```

**IDs and identifiers:** Account `id` must be a valid **UUID** if provided (e.g. `550e8400-e29b-41d4-a716-446655440000`). If omitted, a UUID is generated by the server.

**Required Fields:**
- `direction`: Either `"debit"` or `"credit"` (case-insensitive; normalized to lowercase)

**Optional Fields:**
- `id`: Custom account ID — must be a valid UUID (auto-generated if not provided)
- `name`: Human-readable account name
- `balance`: Initial balance in smallest currency unit (defaults to 0, must be non-negative integer)
- `currency`: Optional. Omit for single-currency (default USD). Pass a supported code (case-insensitive; normalized to uppercase) when using multi-currency: USD, EUR, GBP, JPY, KWD.

**Response (201):**

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Cash",
  "direction": "debit",
  "balance": 0,
  "currency": "USD"
}
```

---

### 2. Get Account

**GET** `/accounts/:id`

Retrieves an account by ID, including current balance.

**Response (200):**

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Cash",
  "direction": "debit",
  "balance": 10000,
  "currency": "USD"
}
```

**Response (404):**

```json
{
  "error": "Account not found: {id}"
}
```

---

### 3. Create Transaction

**POST** `/transactions`

Creates a new double-entry transaction. The transaction must be balanced (sum of debits equals sum of credits).

**Request Body:**

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Sale of goods",
  "entries": [
    {
      "account_id": "fa967ec9-5be2-4c26-a874-7eeeabfc6da8",
      "direction": "debit",
      "amount": 5000,
      "currency": "USD"
    },
    {
      "account_id": "dbf17d00-8701-4c4e-9fc5-6ae33c324309",
      "direction": "credit",
      "amount": 5000,
      "currency": "USD"
    }
  ]
}
```

**IDs and identifiers:** Transaction `id` (if provided), every entry’s `account_id`, and optional entry `id` (if provided) must be valid **UUIDs** (e.g. `550e8400-e29b-41d4-a716-446655440000`). Account IDs reference accounts created via POST `/accounts`.

**Required Fields:**
- `entries`: Array of at least 2 entries
  - `account_id`: UUID of an existing account
  - `direction`: Either `"debit"` or `"credit"` (case-insensitive; normalized to lowercase)
  - `amount`: Positive integer amount in smallest currency unit

**Optional Fields:**
- `id`: Custom transaction ID — must be a valid UUID (used for idempotency; auto-generated if not provided)
- `name`: Description of the transaction
- `entries[].id`: Optional. If provided must be a valid UUID; if omitted, the entry ID is server-generated.
- `entries[].currency`: Optional. Omit to use the account’s currency. Pass a supported code (case-insensitive; normalized to uppercase) when you need to specify currency for that entry (e.g. for multi-currency support).

Do **not** send `createdAt`. Entry `id` is optional: if provided it must be a valid UUID and is used; if omitted it is server-generated. All other transaction rules (balanced debits/credits, same currency, etc.) are described under [Business Rules](#business-rules) below.

**Response (201):**

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Sale of goods",
  "entries": [
    {
      "id": "9f694f8c-9c4c-44cf-9ca9-0cb1a318f0a7",
      "account_id": "fa967ec9-5be2-4c26-a874-7eeeabfc6da8",
      "direction": "debit",
      "amount": 5000,
      "currency": "USD"
    },
    {
      "id": "a5c1b7f0-e52e-4ab6-8f31-c380c2223efa",
      "account_id": "dbf17d00-8701-4c4e-9fc5-6ae33c324309",
      "direction": "credit",
      "amount": 5000,
      "currency": "USD"
    }
  ],
  "created_at": "2024-01-15T10:30:00.000Z"
}
```

**Error Responses:**

- **400 Bad Request**: Invalid request format or unbalanced transaction
- **404 Not Found**: Referenced account doesn't exist
- **409 Conflict**: Transaction ID already used with different data

---

## Business Rules

### Account Balances Only Change Via Transactions

Account balances can never be modified directly. They can only be changed by creating transactions. There is no endpoint to set or patch an account balance; all balance changes come from applying transaction entries.

### Account Balance Updates

When a transaction is applied, each account balance is updated based on the relationship between the account's natural direction and the entry direction:

```
if (account.direction === entry.direction):
    balance += amount  // Increases balance
else:
    balance -= amount  // Decreases balance
```

**Examples:**
- **Debit account** + **debit entry** = increase balance
- **Debit account** + **credit entry** = decrease balance
- **Credit account** + **credit entry** = increase balance
- **Credit account** + **debit entry** = decrease balance

### Transaction Validation

All transactions must satisfy:

1. At least 2 entries
2. At least one debit AND one credit entry
3. Sum of debit amounts = Sum of credit amounts
4. All referenced accounts must exist
5. All amounts must be positive integers
6. All entries must use the same currency
7. Each entry's currency must match its account's currency

### Atomicity

Transactions are applied atomically:

1. **Validate** all business rules (no state changes)
2. **Calculate** balance changes for all affected accounts
3. **Apply** all balance updates
4. **Save** the transaction record

If validation fails at any step, no changes are made to any account.

---

## Idempotency

Transactions support idempotency using the optional `id` field:

- **With ID**: If a transaction with the same ID already exists:
  - Same payload: returns existing transaction (no duplicate processing)
  - Different payload: returns 409 Conflict error
- **Without ID**: No idempotency guarantee, always creates new transaction

The system normalizes transactions for comparison by:
- Sorting entries by account_id, direction, and amount
- Ignoring entry IDs and timestamps
- Treating undefined and empty string names as equivalent

---

## Example Usage

### Complete Workflow

```bash
# 1. Create a Cash account (debit type) with a UUID
curl -X POST http://localhost:3000/accounts \
  -H "Content-Type: application/json" \
  -d '{
    "id": "fa967ec9-5be2-4c26-a874-7eeeabfc6da8",
    "name": "Cash",
    "direction": "debit",
    "balance": 0
  }'

# Response:
# {
#   "id": "fa967ec9-5be2-4c26-a874-7eeeabfc6da8",
#   "name": "Cash",
#   "direction": "debit",
#   "balance": 0,
#   "currency": "USD"
# }

# 2. Create a Revenue account (credit type) with a UUID
curl -X POST http://localhost:3000/accounts \
  -H "Content-Type: application/json" \
  -d '{
    "id": "dbf17d00-8701-4c4e-9fc5-6ae33c324309",
    "name": "Revenue",
    "direction": "credit",
    "balance": 0
  }'

# Response:
# {
#   "id": "dbf17d00-8701-4c4e-9fc5-6ae33c324309",
#   "name": "Revenue",
#   "direction": "credit",
#   "balance": 0,
#   "currency": "USD"
# }

# 3. Create a balanced transaction (sale of $50.00 = 5000 cents)
curl -X POST http://localhost:3000/transactions \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Sale of goods",
    "entries": [
      {
        "account_id": "fa967ec9-5be2-4c26-a874-7eeeabfc6da8",
        "direction": "debit",
        "amount": 5000
      },
      {
        "account_id": "dbf17d00-8701-4c4e-9fc5-6ae33c324309",
        "direction": "credit",
        "amount": 5000
      }
    ]
  }'

# Response includes server-generated entry IDs and created_at timestamp

# 4. Check updated Cash balance
curl http://localhost:3000/accounts/fa967ec9-5be2-4c26-a874-7eeeabfc6da8

# Response:
# {
#   "id": "fa967ec9-5be2-4c26-a874-7eeeabfc6da8",
#   "name": "Cash",
#   "direction": "debit",
#   "balance": 5000,
#   "currency": "USD"
# }

# 5. Check updated Revenue balance
curl http://localhost:3000/accounts/dbf17d00-8701-4c4e-9fc5-6ae33c324309

# Response:
# {
#   "id": "dbf17d00-8701-4c4e-9fc5-6ae33c324309",
#   "name": "Revenue",
#   "direction": "credit",
#   "balance": 5000,
#   "currency": "USD"
# }
```

---

### Example: Unbalanced Transaction (Error)

```bash
curl -X POST http://localhost:3000/transactions \
  -H "Content-Type: application/json" \
  -d '{
    "entries": [
      {
        "account_id": "fa967ec9-5be2-4c26-a874-7eeeabfc6da8",
        "direction": "debit",
        "amount": 5000
      },
      {
        "account_id": "dbf17d00-8701-4c4e-9fc5-6ae33c324309",
        "direction": "credit",
        "amount": 3000
      }
    ]
  }'

# Response (400):
# {
#   "error": "Transaction must be balanced: debits=5000, credits=3000"
# }
```

---

### Example: Idempotent Retry

```bash
# First request with custom transaction UUID
curl -X POST http://localhost:3000/transactions \
  -H "Content-Type: application/json" \
  -d '{
    "id": "3256dc3c-7b18-4a21-95c6-146747cf2971",
    "name": "Sale",
    "entries": [
      {
        "account_id": "fa967ec9-5be2-4c26-a874-7eeeabfc6da8",
        "direction": "debit",
        "amount": 2500
      },
      {
        "account_id": "dbf17d00-8701-4c4e-9fc5-6ae33c324309",
        "direction": "credit",
        "amount": 2500
      }
    ]
  }'

# Exact same request again (network retry scenario)
curl -X POST http://localhost:3000/transactions \
  -H "Content-Type: application/json" \
  -d '{
    "id": "3256dc3c-7b18-4a21-95c6-146747cf2971",
    "name": "Sale",
    "entries": [
      {
        "account_id": "fa967ec9-5be2-4c26-a874-7eeeabfc6da8",
        "direction": "debit",
        "amount": 2500
      },
      {
        "account_id": "dbf17d00-8701-4c4e-9fc5-6ae33c324309",
        "direction": "credit",
        "amount": 2500
      }
    ]
  }'

# Response: Returns the same transaction
# Balances are only updated ONCE (idempotent)
```

---

### Example: Multi-Currency Support

```bash
# Create a EUR account with a UUID
curl -X POST http://localhost:3000/accounts \
  -H "Content-Type: application/json" \
  -d '{
    "id": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
    "name": "EUR Cash",
    "direction": "debit",
    "currency": "EUR"
  }'

# Response:
# {
#   "id": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
#   "name": "EUR Cash",
#   "direction": "debit",
#   "balance": 0,
#   "currency": "EUR"
# }

# Create a EUR Revenue account with a UUID
curl -X POST http://localhost:3000/accounts \
  -H "Content-Type: application/json" \
  -d '{
    "id": "b2c3d4e5-f6a7-4b8c-9d0e-1f2a3b4c5d6e",
    "name": "EUR Revenue",
    "direction": "credit",
    "currency": "EUR"
  }'

# Create EUR transaction (€50.00 = 5000 cents)
curl -X POST http://localhost:3000/transactions \
  -H "Content-Type: application/json" \
  -d '{
    "name": "European sale",
    "entries": [
      {
        "account_id": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
        "direction": "debit",
        "amount": 5000,
        "currency": "EUR"
      },
      {
        "account_id": "b2c3d4e5-f6a7-4b8c-9d0e-1f2a3b4c5d6e",
        "direction": "credit",
        "amount": 5000,
        "currency": "EUR"
      }
    ]
  }'
```

---

### Example: Mixed Currency Transaction (Error)

```bash
# Attempting to mix USD and EUR in one transaction
curl -X POST http://localhost:3000/transactions \
  -H "Content-Type: application/json" \
  -d '{
    "entries": [
      {
        "account_id": "fa967ec9-5be2-4c26-a874-7eeeabfc6da8",
        "direction": "debit",
        "amount": 5000,
        "currency": "USD"
      },
      {
        "account_id": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
        "direction": "credit",
        "amount": 5000,
        "currency": "EUR"
      }
    ]
  }'

# Response (400):
# {
#   "error": "Transaction cannot mix currencies: USD, EUR"
# }
```

---

## Testing

The project includes comprehensive test coverage:

- **Unit Tests**: Services, Validators, Presenters, Repositories
- **API Tests**: Full HTTP endpoint integration tests with supertest

**Test Statistics:**
- 12 test suites
- 108 tests
- 100% passing

All tests use in-memory repositories that are cleared between test runs.

---

## License

MIT
